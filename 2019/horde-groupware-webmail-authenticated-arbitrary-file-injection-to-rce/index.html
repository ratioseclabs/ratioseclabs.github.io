<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE | RatioSec </title> <meta name="description" content=" Information Security "> <meta name="keywords" content="RatioSec, security, cyber security, application security, network security, penetration testing"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="RatioSec"> <meta property="article:section" content="research"> <meta property="article:tag" content=""> <meta property="article:published_time" content="2019-03-24 21:54:52 +0000"> <meta property="og:url" content="http://www.ratiosec.com/2019/horde-groupware-webmail-authenticated-arbitrary-file-injection-to-rce/"> <meta property="og:title" content=" Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE | RatioSec "> <meta property="og:image" content="http://www.ratiosec.com"> <meta property="og:description" content=" Information Security "> <meta property="og:site_name" content="RatioSec"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@ratio_sec"> <meta name="twitter:title" content=" Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE | RatioSec "> <meta name="twitter:description" content=" Information Security "> <meta name="twitter:image:src" content="http://www.ratiosec.com"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE | RatioSec "> <meta itemprop="description" content=" Information Security "> <meta itemprop="image" content="http://www.ratiosec.com"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://www.ratiosec.com/2019/horde-groupware-webmail-authenticated-arbitrary-file-injection-to-rce/"> <link rel="alternate" type="application/rss+xml" title="RatioSec" href="http://www.ratiosec.com/feed.xml"> <link rel="shortcut icon" href="/assets/images/favicon.png"> <script type="text/javascript"> var disqus_shortname = 'ratiosec'; var _gaq = _gaq || []; _gaq.push(['_setAccount', '']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/"><img src="/assets/images/logo.png"></a></h1> <ul class="navbar"> <li><a href="/services">Services</a></li> <li><a href="/research">Research</a></li> <li><a href="/contact">Contact</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <h1 class="post-title" itemprop="name headline">Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE</h1> <p class="post-meta"><time datetime="2019-03-24T21:54:52+00:00" itemprop="datePublished">Mar 24, 2019</time></p> </header> <div class="post-content" itemprop="articleBody"> <table> <tbody> <tr> <td>Advisory ID</td> <td>RS-2019-001</td> </tr> <tr> <td>Product</td> <td>Horde Groupware Webmail</td> </tr> <tr> <td>Vendor</td> <td>Horde LLC</td> </tr> <tr> <td>Tested Versions</td> <td>5.2.22 and 5.2.17 with Horde Form &lt; 2.0.19</td> </tr> <tr> <td>Other Vulnerable Versions</td> <td>Prior versions may also be affected</td> </tr> <tr> <td>Vendor Notification</td> <td>December 2018</td> </tr> <tr> <td>Advisory Publication</td> <td>24rd March, 2019</td> </tr> <tr> <td>CVE Reference</td> <td>CVE-2019-9858</td> </tr> <tr> <td>Risk Level</td> <td>High</td> </tr> <tr> <td>CVSSv3 Base Score</td> <td>CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H</td> </tr> </tbody> </table> <h1 id="advisory">Advisory</h1> <p>RatioSec Research has discovered an arbitrary file write vulnerability that leads to remote code execution in Horde Groupware Webmail.</p> <p>This can be exploited by an authenticated, unprivileged user to create a malicious PHP file under the Horde web root and gain arbitrary code execution on the server.</p> <p>The vulnerability is located in the core Horde source code and has been proven exploitable with the installed default Turba address book component.</p> <p>The exploit has been proven working with the stable release Horde Groupware Webmail 5.2.22 and 5.2.17 with Horde Form subcomponent &lt; 2.0.19. Other versions may also be affected.</p> <h1 id="proof-of-concept">Proof Of Concept</h1> <p>The Horde file <code>Horde/Form/Type.php</code> contains the vulnerable class that handles the image upload in forms.</p> <p>When the <code>Horde_Form_Type_image</code> method <code>onSubmit()</code> is called on uploads it invokes the functions <code>getImage()</code> and <code>_getUpload()</code>, which uses unsanitized user input as path to save the image.</p> <p><img src="/assets/images/posts/RS-2019-001/image1.png" alt="Function uses unsanitized input to rename the uploaded file " /></p> <p>The unsanitized post parameter <code>object[photo][img][file]</code> is saved in the <code>$upload['img']['file']</code> php variable, allowing an attacker to manipulate the <code>$tmp_file</code> passed to <code>move_uploaded_file()</code> to save the uploaded file.</p> <p>Set the parameter to e.g. <code>../usr/share/horde/static/bd.php</code> to write a php backdoor inside the web root. the <code>static/</code> destination folder is a good candidate to drop the backdoor because is always writable in horde installations.</p> <p>The unsanitized POST parameter went probably unnoticed because itâ€™s never submitted by the forms which default to securely use a random path.</p> <h3 id="steps-to-reproduce">Steps to reproduce</h3> <ol> <li>Log into the Horde Groupware Webmail as normal user.</li> <li>Access the <code>New Contact</code> view via <code>Address Book</code> in the menu.</li> <li>Create a PHP backdoor file on your disk.</li> <li> <p>Fill the mandatory fields submitting the PHP backdoor in the <code>Photo</code> file field. The file name is irrelevant.</p> <p><img src="/assets/images/posts/RS-2019-001/image2.png" alt="Step 4" /></p> </li> <li> <p>Click the Add button and intercept the outgoing HTTP request using Burp Suite. You should see the POST data including the uploaded PHP backdoor.</p> <p><img src="/assets/images/posts/RS-2019-001/image3.png" alt="Step 5" /></p> </li> <li>Add the new POST field <code>object[photo][img][file]</code> with the path to traverse the temporary folder and save the PHP backdoor under under the <code>static/</code> folder. Two path traversals have been found working in different installations: <ul> <li><code>./usr/share/horde/static/bd.php</code>, working with Horde installed with <code>apt-get</code></li> <li><code>./var/www/html/horde/static/bd.php</code>, working with Horde manually installed with PEAR</li> </ul> <p><img src="/assets/images/posts/RS-2019-001/image4.png" alt="Step 6" /></p> </li> <li>Forward the request to the target server.</li> <li> <p>Use the uploaded PHP file to execute arbitrary commands.</p> <p><img src="/assets/images/posts/RS-2019-001/image5.png" alt="Step 8" /></p> </li> </ol> <h3 id="metasploit-module">Metasploit module</h3> <p>Install the module under <code>~/.msf4/modules/exploits/unix/webapp/horde_turba_file_upload.rb</code>. The module automatically exploits the Horde across different configurations, both if manually installed with PEAR or with apt-get.</p> <p><img src="/assets/images/posts/RS-2019-001/image6.jpg" alt="Metasploit" /></p> <h1 id="solution">Solution</h1> <p>Update Horde Form subcomponent to the version 2.0.19 or later.</p> <h1 id="timeline">Timeline</h1> <ul> <li>Disclosure to <a href="https://ssd-disclosure.com/">SSD</a>: 26th July, 2018</li> <li>Fixed in Horde Form Git <a href="https://github.com/horde/Form/commit/c916ba979ad1613d76a9407dd0b67968a9594c0e#diff-a09a0502cb30c4dc17838ad8b365f5e9">repository</a>: 4th February, 2019</li> <li>Release Horde Form 2.0.19: 6th February, 2019</li> <li>Advisory Publication by <a href="https://ssd-disclosure.com/index.php/archives/3814">SSD</a>: 24rd March, 2019</li> </ul> <aside class="share"> <h4>Share this.</h4> <a href="http://twitter.com/share?text=Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE&amp;url=http://www.ratiosec.com/2019/horde-groupware-webmail-authenticated-arbitrary-file-injection-to-rce/&amp;hashtags=web,dev,blog,soudev&amp;via=ratio_sec" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter</a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.ratiosec.com/2019/horde-groupware-webmail-authenticated-arbitrary-file-injection-to-rce/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=235');return false;">Facebook</a> </aside> </div> </article> <aside id="comments" class="disqus"> <div class="container"> <h3><i class="icon icon-comments-o"></i> Comments</h3> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'ratiosec'; var disqus_identifier = '/2019/horde-groupware-webmail-authenticated-arbitrary-file-injection-to-rce'; var disqus_title = 'Horde Groupware Webmail Authenticated Arbitrary File Injection to RCE'; var disqus_url = 'http://www.ratiosec.com'; /*var disqus_developer = 1;*/ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a> </noscript> </div> </aside> <footer class="site-footer"> <div class="container"> <small class="pull-left">RatioSec 2019. Except where otherwise noted, this website is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International Licence</a>.</small> </div> </footer> </main> </body> </html>
